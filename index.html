<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨æ–¹ä½æˆ¿åœ°ç”¢ç¨…å‹™è¨ˆç®—æ©Ÿ</title>
    
    <!-- 1. è¼‰å…¥ Tailwind CSS (æ¨£å¼) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. è¼‰å…¥ React èˆ‡ Babel (æ ¸å¿ƒé‚è¼¯) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. è¨­å®šå­—é«” (æ¨™æ¥·é«”/å¾®è»Ÿæ­£é»‘é«”) -->
    <style>
        body, input, select, button, textarea {
            font-family: "Microsoft JhengHei", "PingFang TC", "Heiti TC", "Apple LiGothic", sans-serif !important;
        }
        /* éš±è—åˆ—å°æ™‚çš„éå¿…è¦å…ƒç´  */
        @media print { 
            body { background: white; } 
            .print\:hidden { display: none !important; } 
            .print\:bg-white { background: white !important; color: black !important; } 
            .print\:border { border: 1px solid #ddd !important; } 
            .print\:shadow-none { box-shadow: none !important; } 
            .print\:p-4 { padding: 1rem !important; }
            .print\:text-black { color: black !important; }
            .print\:border-gray-300 { border-color: #d1d5db !important; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <!-- 4. æ‡‰ç”¨ç¨‹å¼ä¸»é‚è¼¯ -->
    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Calculator, DollarSign, Users, Code, Crown, Leaf, AlertCircle, Sparkles, 
            CheckCircle2, ArrowRight, PiggyBank, Home, TrendingUp, Archive, Calendar, 
            Info, Gift, Printer, Moon, Shield, FileText, PieChart as PieChartIcon, 
            Umbrella, BarChart2, TrendingDown, Copy, Briefcase, RotateCcw, Bot, Key, 
            Eye, EyeOff, Trash2
        } from 'https://esm.sh/lucide-react@0.292.0';

        // --- Constants ---
        const ESTATE_TAX_RULES_2025 = {
            exemption: 13330000,
            deductions: { spouse: 5530000, parent: 1380000, child: 560000, sibling: 560000, disabled: 6930000, funeral: 1380000 },
            brackets: [ { limit: 56210000, rate: 0.10, progressiveDeduction: 0 }, { limit: 112420000, rate: 0.15, progressiveDeduction: 2810500 }, { limit: Infinity, rate: 0.20, progressiveDeduction: 8431500 } ]
        };
        const GIFT_TAX_RULES_2025 = {
            exemption: 2440000,
            brackets: [ { limit: 25000000, rate: 0.10, deduction: 0 }, { limit: 50000000, rate: 0.15, deduction: 1250000 }, { limit: Infinity, rate: 0.20, deduction: 3750000 } ]
        };
        const INSURANCE_AMT_EXEMPTION = 37400000; 
        const systemApiKey = "AIzaSyDOHS-pnsQLKmc5IYvYcgz4WXwD6nXZTjk"; 
        const STORAGE_PREFIX = 'tax_calc_sales_v12_'; 

        // --- Helpers ---
        const formatCurrency = (num) => {
            if (num === null || num === undefined || isNaN(num)) return "$0";
            return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(num);
        };
        const parseInput = (val) => {
            if (val === '' || val === undefined || val === null) return 0;
            const cleanVal = String(val).replace(/[^\d.-]/g, ''); 
            const num = parseFloat(cleanVal);
            return isNaN(num) ? 0 : num;
        };
        const getScenarios = () => {
            try {
                const saved = localStorage.getItem(STORAGE_PREFIX + 'scenarios');
                return saved ? JSON.parse(saved) : { 'default': { name: 'é è¨­å®¢æˆ¶', data: {} } };
            } catch { return { 'default': { name: 'é è¨­å®¢æˆ¶', data: {} } }; }
        };

        // --- Themes ---
        const THEMES = {
            nordic: { id: 'nordic', name: 'åŒ—æ­æ£®æ—', icon: <Leaf size={18} />, bgMain: 'bg-[#eef2f3] text-slate-700 font-sans print:bg-white', header: 'bg-[#dbece5] border-b border-[#c8e1d6] text-[#2c5f4c] print:hidden', card: 'bg-white rounded-3xl shadow-sm border border-[#e0e7e4] p-6 print:shadow-none print:border print:p-4', inputLabel: 'block text-sm font-bold text-[#4a6b5d] mb-2', inputField: 'w-full rounded-2xl border-[#cbd5d0] focus:ring-2 focus:ring-[#5b9e84] focus:border-[#5b9e84] transition-all py-3 px-4 bg-[#f8faf9]', valueDisplay: 'w-full py-3 px-4 bg-transparent border-b border-[#cbd5d0] text-[#2f8565] font-bold text-lg', accentColor: 'text-[#2f8565]', accentBg: 'bg-[#2f8565]', tabActive: 'text-[#1e5742] bg-white shadow-sm rounded-xl font-bold', tabInactive: 'text-[#6b8c80] hover:text-[#2f8565] hover:bg-[#e6f0ec]', primaryBtn: 'bg-[#2f8565] hover:bg-[#256a50] text-white rounded-xl shadow-md transition-all print:hidden', resultBox: 'bg-[#2c5f4c] text-white rounded-3xl shadow-lg print:bg-white print:text-black print:border-2 print:border-black', mobileFooter: 'bg-[#dbece5]/90 backdrop-blur-md border-t border-[#c8e1d6] print:hidden' },
            dark: { id: 'dark', name: 'æ·±è‰²æ¥µå®¢', icon: <Moon size={18} />, bgMain: 'bg-[#0f172a] text-slate-300 font-mono print:bg-white print:text-black', header: 'bg-[#1e293b]/80 backdrop-blur-md border-b border-slate-700 print:hidden', card: 'bg-[#1e293b] rounded-xl shadow-xl border border-slate-700 p-6 print:shadow-none print:border print:p-4 print:bg-white print:text-black', inputLabel: 'block text-xs font-mono text-cyan-400 mb-2 uppercase tracking-wider', inputField: 'w-full rounded-lg border-slate-600 bg-[#0f172a] focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-all py-2.5 px-4 text-white placeholder-slate-600 print:bg-white print:text-black print:border-gray-300', valueDisplay: 'w-full py-2.5 px-4 bg-transparent border-b border-slate-600 text-cyan-300 font-bold text-lg font-mono', accentColor: 'text-cyan-400', accentBg: 'bg-cyan-500', tabActive: 'text-cyan-400 border-b-2 border-cyan-400 bg-cyan-950/30', tabInactive: 'text-slate-500 hover:text-cyan-300 hover:bg-slate-800', primaryBtn: 'bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg shadow-[0_0_15px_rgba(8,145,178,0.5)] transition-all print:hidden', resultBox: 'bg-slate-900 border border-cyan-500/50 text-cyan-50 rounded-xl shadow-2xl print:bg-white print:text-black print:border-2 print:border-black', mobileFooter: 'bg-[#0f172a]/90 backdrop-blur-md border-t border-slate-700 print:hidden' },
            zen: { id: 'zen', name: 'æ—¥å¼ä¾˜å¯‚', icon: <Users size={18} />, bgMain: 'bg-[#f7f3e8] text-[#595045] font-serif tracking-wide print:bg-white', header: 'bg-[#f7f3e8] border-b border-[#e6dfcc] print:hidden', card: 'bg-[#fdfbf7] rounded-sm shadow-[2px_2px_10px_rgba(0,0,0,0.03)] border border-[#e6dfcc] p-8 print:shadow-none print:border print:p-4', inputLabel: 'block text-sm font-medium text-[#8c8273] mb-2', inputField: 'w-full border-b border-[#c2b8a3] bg-transparent focus:border-[#8f5e47] outline-none transition-colors py-2 px-1 text-[#4a4238] rounded-none placeholder-[#c2b8a3]', valueDisplay: 'w-full py-2 px-1 bg-transparent border-b-2 border-[#8f5e47] text-[#4a4238] font-bold text-lg', accentColor: 'text-[#8f5e47]', accentBg: 'bg-[#8f5e47]', tabActive: 'text-[#4a4238] font-bold border-l-4 border-[#8f5e47] bg-[#f0ebe0] pl-4', tabInactive: 'text-[#9e9486] hover:text-[#595045] hover:bg-[#f0ebe0]/50 pl-4 border-l-4 border-transparent', primaryBtn: 'bg-[#595045] hover:bg-[#4a4238] text-[#f7f3e8] rounded-sm px-6 py-2 transition-all print:hidden', resultBox: 'bg-[#4a4238] text-[#f7f3e8] rounded-sm shadow-md p-6 print:bg-white print:text-black print:border-2 print:border-black', mobileFooter: 'bg-[#f7f3e8]/95 border-t border-[#e6dfcc] print:hidden' }
        };

        // --- Components ---

        function InputField({ label, value, onChange, theme, placeholder, type = "text", prefix, step, highlight, readOnly, warning }) {
            const [isFocused, setIsFocused] = useState(false);
            if (readOnly) {
                return (
                    <div className="relative mb-2">
                        <label className={theme.inputLabel}>{label}</label>
                        <div className={`flex items-center ${theme.valueDisplay}`}>
                            {(prefix || type === 'number') && <span className="mr-1 opacity-70 text-sm">{prefix || '$'}</span>}
                            {type === 'number' ? formatCurrency(value).replace('NT$', '').trim() : value}
                        </div>
                        {warning && <p className="text-xs text-red-500 mt-1 font-bold">{warning}</p>}
                    </div>
                );
            }
            return (
                <div className="relative mb-2">
                    <label className={theme.inputLabel}>{label}</label>
                    <div className="relative group">
                        {(prefix || type === 'number') && (
                        <div className={`absolute left-0 top-1/2 -translate-y-1/2 pl-3 pointer-events-none transition-colors ${isFocused ? theme.accentColor : 'text-gray-400'}`}>
                            {theme.id === 'zen' ? <span className="text-xs">{prefix || '$'}</span> : (prefix || <DollarSign size={16} />)}
                        </div>
                        )}
                        <input
                            type={type}
                            value={value === 0 && type === 'number' ? '' : value}
                            onChange={(e) => onChange(type === 'number' ? e.target.value : e.target.value)}
                            onFocus={(e) => { setIsFocused(true); if(type==='number') e.target.select(); }}
                            onBlur={() => setIsFocused(false)}
                            step={step}
                            className={`${theme.inputField} ${(prefix || type === 'number') ? 'pl-8' : ''} ${highlight && theme.id !== 'zen' ? 'font-bold ring-1 ring-offset-1 ring-blue-100' : ''}`}
                            placeholder={placeholder}
                        />
                    </div>
                    {warning && <p className="text-xs text-red-500 mt-1">{warning}</p>}
                </div>
            );
        }

        function SelectField({ label, value, onChange, options, theme, readOnly }) {
            if (readOnly) {
                const selected = options.find(o => o.value === value);
                return (
                    <div className="relative mb-2">
                        <label className={theme.inputLabel}>{label}</label>
                        <div className={theme.valueDisplay}>{selected ? selected.label : value}</div>
                    </div>
                );
            }
            return (
                <div className="relative mb-2">
                    <label className={theme.inputLabel}>{label}</label>
                    <select value={value} onChange={(e) => onChange(e.target.value)} className={`${theme.inputField} appearance-none cursor-pointer`}>
                        {options.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                    </select>
                </div>
            )
        }

        function ResultRow({ label, value, isDeduction = false, theme, highlightColor, subLabel }) {
            return (
                <div className={`flex justify-between items-start py-2.5 ${theme.id === 'zen' ? 'border-b border-dotted border-[#dcd6c6]' : 'border-b border-dashed border-gray-100/10'} last:border-0 print:border-gray-300`}>
                    <div className="flex flex-col">
                        <span className={`${theme.id === 'zen' ? 'text-[#595045]' : (theme.id === 'dark' ? 'text-slate-400' : 'text-slate-600')} text-sm`}>{label}</span>
                        {subLabel && <span className="text-xs text-gray-400 mt-0.5 print:text-gray-600">{subLabel}</span>}
                    </div>
                    <span className={`font-medium ${highlightColor ? highlightColor : isDeduction ? 'text-green-500' : (theme.id === 'zen' ? 'text-[#2c2824]' : (theme.id === 'dark' ? 'text-slate-200' : 'text-slate-900'))}`}>
                        {isDeduction ? '-' : ''} {typeof value === 'number' ? formatCurrency(value) : value}
                    </span>
                </div>
            );
        }

        const EstateStackChart = ({ totalAssets, totalDeductions, theme }) => {
            const assets = Number(totalAssets) || 0;
            const deductions = Number(totalDeductions) || 0;
            if (assets === 0) return null;
            const deductionWidth = Math.min(100, (deductions / assets) * 100);
            const taxableWidth = Math.max(0, 100 - deductionWidth);
            return (
                <div className={`w-full overflow-hidden mt-4 relative rounded-xl p-3 border ${theme.id === 'dark' ? 'bg-slate-700/50 border-slate-600' : 'bg-gray-50/50 border-gray-100'}`}>
                    <h4 className={`text-xs text-center mb-3 font-bold ${theme.id === 'dark' ? 'text-slate-400' : 'text-gray-500'}`}>éºç”¢ç¨…æŠµæ‰£è¦†è“‹ç‡</h4>
                    <div className="relative h-8 w-full bg-gray-200 rounded-full overflow-hidden flex">
                        <div className="h-full bg-green-500 flex items-center justify-center text-xs text-white font-bold transition-all duration-1000" style={{ width: `${deductionWidth}%` }}>
                            {deductionWidth > 15 ? 'å…ç¨…+æ‰£é™¤é¡' : ''}
                        </div>
                        <div className="h-full bg-red-400 flex items-center justify-center text-xs text-white font-bold transition-all duration-1000" style={{ width: `${taxableWidth}%` }}>
                            {taxableWidth > 15 ? 'èª²ç¨…éƒ¨åˆ†' : ''}
                        </div>
                    </div>
                    <div className="flex justify-between text-xs mt-2 opacity-70">
                        <span>ç¸½æ‰£é™¤é¡: {formatCurrency(deductions)}</span>
                        <span className={taxableWidth > 0 ? 'text-red-500 font-bold' : 'text-green-600 font-bold'}>
                            {taxableWidth > 0 ? `æ·¨é¡: ${formatCurrency(assets - deductions)}` : 'å®Œå…¨å…ç¨…'}
                        </span>
                    </div>
                </div>
            );
        };

        const LineChart = ({ data, theme }) => {
            if (!data || data.length === 0) return null;
            const width = 300; const height = 150; const padding = 20;
            const allValues = data.flatMap(d => [d.paid, d.value]);
            const maxY = Math.max(...allValues, 100) * 1.1; 
            const maxX = data.length > 1 ? data.length - 1 : 1;
            const getX = (i) => padding + (i / maxX) * (width - 2 * padding);
            const getY = (v) => height - padding - (v / maxY) * (height - 2 * padding);
            const pointsPaid = data.map((d, i) => `${getX(i)},${getY(d.paid)}`).join(' ');
            const pointsValue = data.map((d, i) => `${getX(i)},${getY(d.value)}`).join(' ');
            let breakEvenIndex = -1;
            for(let i=0; i<data.length; i++) { if(data[i].value >= data[i].paid) { breakEvenIndex = i; break; } }
            return (
                <div className="w-full overflow-hidden mt-4 relative">
                <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-auto">
                    <defs>
                        <linearGradient id="gradientValue" x1="0" x2="0" y1="0" y2="1">
                            <stop offset="0%" stopColor={theme.id==='nordic'?'#2f8565':(theme.id==='dark'?'#22d3ee':'#8f5e47')} stopOpacity="0.3" />
                            <stop offset="100%" stopColor={theme.id==='nordic'?'#2f8565':(theme.id==='dark'?'#22d3ee':'#8f5e47')} stopOpacity="0" />
                        </linearGradient>
                    </defs>
                    <line x1={padding} y1={height - padding} x2={width - padding} y2={height - padding} stroke="#ccc" strokeWidth="1" />
                    <line x1={padding} y1={padding} x2={padding} y2={height - padding} stroke="#ccc" strokeWidth="1" />
                    <polygon points={`${padding},${height-padding} ${pointsValue} ${width-padding},${height-padding}`} fill="url(#gradientValue)" />
                    <polyline points={pointsPaid} fill="none" stroke="#94a3b8" strokeWidth="1.5" strokeDasharray="4" />
                    <polyline points={pointsValue} fill="none" stroke={theme.id==='nordic'?'#2f8565':(theme.id==='dark'?'#22d3ee':'#8f5e47')} strokeWidth="2.5" />
                    {breakEvenIndex !== -1 && (<circle cx={getX(breakEvenIndex)} cy={getY(data[breakEvenIndex].value)} r="3" fill="#f87171" stroke="white" strokeWidth="1"/>)}
                    <text x={width-padding} y={getY(data[data.length-1].paid)-5} fontSize="9" fill="#94a3b8" textAnchor="end">ç¸½ä¿è²»</text>
                    <text x={width-padding} y={getY(data[data.length-1].value)-5} fontSize="9" fill={theme.id==='nordic'?'#2f8565':(theme.id==='dark'?'#22d3ee':'#8f5e47')} textAnchor="end" fontWeight="bold">ä¿å–®åƒ¹å€¼</text>
                </svg>
                </div>
            );
        };

        const ComparisonBarChart = ({ cashTax, propertyTax, theme }) => {
            const width = 300; const height = 120; const padding = 20; const barWidth = 40;
            const cTax = Number(cashTax) || 0; const pTax = Number(propertyTax) || 0;
            if (cTax === 0 && pTax === 0) return null;
            const maxVal = Math.max(cTax, pTax, 10); 
            const cHeight = (cTax / maxVal) * (height - padding * 2);
            const pHeight = (pTax / maxVal) * (height - padding * 2);
            const colorCash = '#94a3b8'; const colorProp = '#22c55e'; 
            return (
                <div className={`w-full overflow-hidden mt-4 relative rounded-xl p-2 border ${theme.id === 'dark' ? 'bg-slate-700/50 border-slate-600' : 'bg-gray-50/50 border-gray-100'}`}>
                    <h4 className={`text-xs text-center mb-2 font-bold ${theme.id === 'dark' ? 'text-slate-400' : 'text-gray-500'}`}>ç¨…é¡æ¯”è¼ƒ (å–®ä½:è¬)</h4>
                    <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-auto">
                        <line x1={padding} y1={height - padding} x2={width - padding} y2={height - padding} stroke={theme.id==='dark' ? '#475569' : '#ccc'} strokeWidth="1" />
                        <rect x={width/3 - barWidth} y={height - padding - cHeight} width={barWidth} height={cHeight} fill={colorCash} rx="4" />
                        <text x={width/3 - barWidth/2} y={height - padding - cHeight - 5} fontSize="12" fill={colorCash} textAnchor="middle" fontWeight="bold">{cTax}</text>
                        <text x={width/3 - barWidth/2} y={height - 5} fontSize="10" fill={theme.id==='dark'?'#94a3b8':'#666'} textAnchor="middle">ç¾é‡‘è´ˆèˆ‡</text>
                        <rect x={width*2/3} y={height - padding - pHeight} width={barWidth} height={pHeight} fill={colorProp} rx="4" />
                        <text x={width*2/3 + barWidth/2} y={height - padding - pHeight - 5} fontSize="12" fill={colorProp} textAnchor="middle" fontWeight="bold">{pTax}</text>
                        <text x={width*2/3 + barWidth/2} y={height - 5} fontSize="10" fill={theme.id==='dark'?'#94a3b8':'#666'} textAnchor="middle">æˆ¿ç”¢è´ˆèˆ‡</text>
                    </svg>
                </div>
            )
        }

        const SimplePieChart = ({ data, size = 100, theme }) => {
            if (!data) return null;
            const total = data.reduce((acc, item) => acc + (item.value || 0), 0);
            if (total === 0) return <div className="w-full h-24 bg-gray-100/10 rounded-full flex items-center justify-center text-xs text-gray-400">å°šç„¡è³‡æ–™</div>;
            let currentAngle = 0;
            return (
                <div className="flex items-center gap-4">
                <svg width={size} height={size} viewBox="-1 -1 2 2" style={{ transform: 'rotate(-90deg)' }}>
                    {data.map((item, index) => {
                    const val = item.value || 0;
                    const sliceAngle = (val / total) * 2 * Math.PI;
                    const x1 = Math.cos(currentAngle);
                    const y1 = Math.sin(currentAngle);
                    const x2 = Math.cos(currentAngle + sliceAngle);
                    const y2 = Math.sin(currentAngle + sliceAngle);
                    const largeArcFlag = sliceAngle > Math.PI ? 1 : 0;
                    const pathData = `M 0 0 L ${x1} ${y1} A 1 1 0 ${largeArcFlag} 1 ${x2} ${y2} Z`;
                    currentAngle += sliceAngle;
                    return <path key={index} d={pathData} fill={item.color} stroke={theme.id === 'dark' ? '#1e293b' : 'white'} strokeWidth="0.05" />;
                    })}
                </svg>
                <div className="flex flex-col gap-1 text-xs">
                    {data.map((item, index) => (
                    (item.value || 0) > 0 && (
                        <div key={index} className="flex items-center gap-2">
                        <span className="w-2 h-2 rounded-full" style={{ backgroundColor: item.color }}></span>
                        <span className={`opacity-80 ${theme.id==='dark'?'text-slate-300':''}`}>{item.label}: {Math.round((item.value/total)*100)}%</span>
                        </div>
                    )
                    ))}
                </div>
                </div>
            );
        };

        const TaxBracketProgress = ({ currentAmount, brackets, theme }) => {
            const nextBracket = brackets.find(b => b.limit > currentAmount);
            if (!nextBracket || nextBracket.limit === Infinity) return null;
            const progress = Math.min(100, (currentAmount / nextBracket.limit) * 100);
            return (
                <div className="mt-4 print:hidden">
                <div className={`flex justify-between text-xs mb-1 ${theme.id === 'dark' ? 'text-slate-500' : 'text-gray-500'}`}>
                    <span>ç›®å‰ç´šè·: {(brackets.find(b => b.limit >= currentAmount)?.rate || 0.1) * 100}%</span>
                    <span>è·é›¢ä¸‹å€‹ç´šè· ({nextBracket.rate * 100}%) é‚„å·® {formatCurrency(nextBracket.limit - currentAmount)}</span>
                </div>
                <div className={`w-full rounded-full h-2.5 ${theme.id === 'dark' ? 'bg-slate-700' : 'bg-gray-200'}`}>
                    <div className={`h-2.5 rounded-full ${theme.accentBg} transition-all duration-500`} style={{ width: `${progress}%` }}></div>
                </div>
                </div>
            );
        };

        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        
        async function callGeminiTaxAdvisor(contextData, tabName, activeKey) {
            if (!activeKey) return "âš ï¸ è«‹è¼¸å…¥ API Key ä»¥å•Ÿç”¨ AI é¡§å•ã€‚";
            const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å°ç£ç¨…å‹™é¡§å•èˆ‡è³‡ç”¢é…ç½®å°ˆå®¶ (2025å¹´æœ€æ–°æ³•è¦)ã€‚è«‹é‡å°ä½¿ç”¨è€…ç›®å‰çš„ã€Œ${tabName}ã€è©¦ç®—æƒ…å¢ƒé€²è¡Œæ·±åº¦è¨ºæ–·ã€‚ä½¿ç”¨è€…æ•¸æ“š JSON: ${JSON.stringify(contextData)}ã€‚è«‹æä¾›ä»¥ä¸‹åˆ†æ (ä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼ŒMarkdown æ ¼å¼)ï¼š1. **ç¨…å‹™ç¾æ³åˆ†æ**ï¼šè§£è®€ç›®å‰çš„ç¨…ç‡ç´šè·èˆ‡é¢¨éšªé»ã€‚2. **ç¯€ç¨…ç­–ç•¥å»ºè­°**ï¼šæä¾› 3 å€‹å…·é«”å¯è¡Œçš„åˆæ³•ç¯€ç¨…æˆ–è³‡ç”¢é…ç½®å»ºè­°ã€‚3. **å°ˆå®¶æé†’**ï¼šé‡å°è©²æ•¸æ“šçµæ§‹çš„æ½›åœ¨ç›²é»ã€‚èªæ°£è«‹å°ˆæ¥­ã€å®¢è§€ä¸”å‹å–„ã€‚`;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${activeKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const backoffDelays = [1000, 2000, 4000, 8000, 16000];
            for (let i = 0; i <= 5; i++) {
                try {
                    const response = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
                    if (!response.ok) {
                        if (response.status === 503 && i < 5) { await wait(backoffDelays[i]); continue; }
                        const errorData = await response.json().catch(() => null);
                        throw new Error(errorData?.error?.message || "API request failed with status " + response.status);
                    }
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "ç„¡æ³•ç”¢ç”Ÿåˆ†æå ±å‘Šï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
                } catch (error) {
                    if (i === 5) return `AI æœå‹™æš«æ™‚å¿™ç¢Œæˆ–é€£ç·šéŒ¯èª¤ (å·²é‡è©¦ 5 æ¬¡)ã€‚è«‹ç¨å¾Œå†è©¦ã€‚\néŒ¯èª¤è¨Šæ¯: ${error.message}`;
                    await wait(backoffDelays[i]);
                }
            }
        }

        const AIAdvisor = ({ suggestions, theme, contextData, tabName }) => {
            const [report, setReport] = useState("");
            const [loading, setLoading] = useState(false);
            const [expanded, setExpanded] = useState(false);
            const [userKey, setUserKey] = useState(""); 
            const handleGenerateReport = async () => {
                const activeKey = userKey || systemApiKey;
                if (!expanded) {
                    setExpanded(true);
                    if (!report && activeKey) {
                        setLoading(true);
                        const result = await callGeminiTaxAdvisor(contextData, tabName, activeKey);
                        setReport(result);
                        setLoading(false);
                    }
                } else { setExpanded(false); }
            };
            const handleConfirmKey = async () => { if(!userKey) return; setLoading(true); const result = await callGeminiTaxAdvisor(contextData, tabName, userKey); setReport(result); setLoading(false); }
            const showInput = expanded && !systemApiKey && !report && !loading;
            return (
                <section className={`${theme.card} ${theme.id === 'dark' ? 'bg-slate-800' : (theme.id === 'zen' ? 'bg-[#f0ebe0]' : 'bg-[#e0e7e4]')} border-none print:hidden transition-all duration-300`}>
                <div className="flex items-center justify-between mb-4">
                    <div className="flex items-center gap-2"> <Sparkles className={theme.accentColor} size={20} /> <h3 className={`font-bold ${theme.accentColor}`}>AI ç¨…å‹™é¡§å•</h3> </div>
                    <button onClick={handleGenerateReport} className={`flex items-center gap-1 text-xs px-3 py-1.5 rounded-full font-bold transition-all ${loading ? 'bg-gray-200 text-gray-500 cursor-wait' : (expanded ? 'bg-gray-200 text-gray-700 hover:bg-gray-300' : `text-white shadow-md hover:opacity-90 ${theme.id==='dark'?'bg-cyan-600':'bg-gradient-to-r from-violet-500 to-fuchsia-500'}`)}`}>
                        {loading ? 'åˆ†æä¸­...' : (expanded ? 'æ”¶åˆå ±å‘Š' : 'âœ¨ ç”Ÿæˆæ·±åº¦è¨ºæ–·')} {!loading && !expanded && <Bot size={14} />}
                    </button>
                </div>
                <div className="space-y-3">
                    {suggestions.map((s, i) => (
                    <div key={i} className={`flex gap-3 p-3 rounded-xl text-sm leading-relaxed shadow-sm ${theme.id==='dark'?'bg-slate-700 text-slate-200':'bg-white text-gray-700'}`}>
                        <div className="mt-0.5 shrink-0">{s.icon}</div> <div><p className="font-bold mb-1">{s.title}</p><p className="opacity-90">{s.content}</p></div>
                    </div>
                    ))}
                </div>
                {expanded && (
                    <div className={`mt-4 pt-4 border-t ${theme.id==='dark'?'border-slate-600':'border-black/5'} animate-in fade-in slide-in-from-top-2`}>
                        {showInput && (
                            <div className="p-4 bg-white/50 rounded-xl space-y-3">
                                <div className="flex items-center gap-2 text-sm text-gray-600"> <Key size={16} /> <span>è«‹è¼¸å…¥ Google Gemini API Key ä»¥å•Ÿå‹• AI åˆ†æï¼š</span> </div>
                                <div className="flex gap-2"> <input type="password" placeholder="AIzaSy..." value={userKey} onChange={(e) => setUserKey(e.target.value)} className="flex-1 p-2 border rounded-lg text-sm" /> <button onClick={handleConfirmKey} className={`px-4 py-2 rounded-lg text-sm text-white ${theme.id==='dark'?'bg-cyan-600':'bg-blue-600'} hover:opacity-90`}> é–‹å§‹åˆ†æ </button> </div>
                                <p className="text-xs text-gray-400"> * æ‚¨çš„ Key åƒ…ç”¨æ–¼ç•¶æ¬¡è«‹æ±‚ï¼Œä¸æœƒè¢«å„²å­˜ã€‚ <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noreferrer" className="underline ml-1">å–å¾—å…è²» Key</a> </p>
                            </div>
                        )}
                        {loading ? (
                            <div className="flex flex-col items-center justify-center py-8 space-y-3 text-gray-500"> <div className="w-6 h-6 border-2 border-current border-t-transparent rounded-full animate-spin"></div> <p className="text-xs">AI æ­£åœ¨åˆ†ææ‚¨çš„ç¨…å‹™è³‡æ–™... (è‹¥ç­‰å¾…è¼ƒä¹…ä»£è¡¨æœå‹™å¿™ç¢Œä¸­)</p> </div>
                        ) : (
                            report && (
                                <div className={`prose prose-sm max-w-none ${theme.id==='dark'?'prose-invert':''} text-sm leading-relaxed whitespace-pre-wrap`}>
                                    {report.split('\n').map((line, idx) => ( <p key={idx} className={line.startsWith('**') || line.startsWith('#') ? 'font-bold mt-2 mb-1 text-base' : 'mb-1 opacity-90'}> {line.replace(/\*\*/g, '').replace(/#/g, '')} </p> ))}
                                    <div className="mt-4 text-xs opacity-50 text-right"> Generated by Gemini AI â€¢ åƒ…ä¾›åƒè€ƒï¼Œä¸ä»£è¡¨æ­£å¼æ³•å¾‹æ„è¦‹ </div>
                                </div>
                            )
                        )}
                    </div>
                )}
                </section>
            );
        };

        const DisclaimerFooter = ({ theme }) => (
            <footer className={`mt-12 py-8 border-t ${theme.id === 'dark' ? 'border-slate-800 text-slate-500' : 'border-gray-200 text-gray-500'} text-xs text-center px-4 print:text-black print:border-t-2 print:border-black`}>
                <div className="max-w-4xl mx-auto space-y-2">
                    <p className="font-bold mb-2 flex items-center justify-center gap-2"> <AlertCircle size={14} /> å°ˆæ¥­å…è²¬è²æ˜ (Professional Disclaimer) </p>
                    <p>1. æœ¬å·¥å…·ä¹‹è©¦ç®—çµæœåƒ…ä¾›æ¥­å‹™åƒè€ƒèˆ‡å…§éƒ¨è¨“ç·´ä½¿ç”¨ï¼Œä¸ä»£è¡¨æ­£å¼ç¨…å‹™ç”³å ±çµæœæˆ–æ³•å¾‹æ„è¦‹ã€‚</p>
                    <p>2. ç¨…å‹™æ³•è¦ï¼ˆå¦‚æˆ¿åœ°åˆä¸€ç¨…ã€éºç”¢åŠè´ˆèˆ‡ç¨…æ³•ã€æ‰€å¾—åŸºæœ¬ç¨…é¡æ¢ä¾‹ï¼‰å¯èƒ½éš¨æ™‚ä¿®è¨‚ï¼Œè«‹ä¾åœ‹ç¨…å±€æœ€æ–°å…¬å‘Šç‚ºæº–ã€‚</p>
                    <p>3. æˆ¿åœ°ç”¢ç›¸é—œæ•¸æ“šï¼ˆå¦‚å…¬å‘Šç¾å€¼ã€è©•å®šç¾å€¼ï¼‰éœ€ç”±ä½¿ç”¨è€…è‡ªè¡ŒæŸ¥è­‰è¼¸å…¥ï¼Œæœ¬å·¥å…·ä¸è² è³‡æ–™æ­£ç¢ºæ€§ä¹‹è²¬ã€‚</p>
                    <p>4. ä¿éšªè¦åŠƒä¹‹æ•¸å€¼ï¼ˆå«IRRã€æŠ•è³‡å ±é…¬ç‡ï¼‰å‡ç‚ºå‡è¨­æ¨¡æ“¬å€¼ï¼Œéä¿è­‰ç²åˆ©ï¼›å¯¦éš›è§£ç´„é‡‘ã€ä¿å–®åƒ¹å€¼æº–å‚™é‡‘ä»¥ä¿éšªå…¬å¸æ­£å¼å»ºè­°æ›¸ç‚ºæº–ã€‚</p>
                    <p>5. é€²è¡Œä»»ä½•é‡å¤§è³‡ç”¢è™•åˆ†æˆ–ç¨…å‹™è¦åŠƒå‰ï¼Œå¼·çƒˆå»ºè­°è«®è©¢å°ˆæ¥­æœƒè¨ˆå¸«ã€åœ°æ”¿å£«æˆ–å¾‹å¸«ã€‚</p>
                </div>
            </footer>
        );

        const CopyButton = ({ textToCopy, theme }) => {
            const [copied, setCopied] = useState(false);
            const handleCopy = () => {
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                textArea.style.top = "0"; textArea.style.left = "0"; textArea.style.position = "fixed";
                document.body.appendChild(textArea);
                textArea.focus(); textArea.select();
                try { document.execCommand('copy'); setCopied(true); setTimeout(() => setCopied(false), 2000); } catch (err) { console.error('Fallback: Oops, unable to copy', err); }
                document.body.removeChild(textArea);
            };
            return (
                <button onClick={handleCopy} className={`p-2 rounded-md transition-all hover:opacity-70 flex items-center gap-1 text-sm ${copied ? 'text-green-600 bg-green-50' : 'text-gray-600 hover:bg-gray-100'}`} title="è¤‡è£½å®¢æˆ¶å ±å‘Šæ‘˜è¦">
                    {copied ? <CheckCircle2 size={18} /> : <Copy size={18} />} <span className="hidden md:inline">{copied ? 'å·²è¤‡è£½' : 'æ‘˜è¦'}</span>
                </button>
            );
        };

        // --- Inner Component for Calculating (Separated for clean reloading on ID change) ---
        // This component handles the form state and calculations based on the activeScenarioId prop
        const TaxCalculatorContent = ({ activeScenarioId, theme, isPresentationMode, onPrint, getSummaryTextRef }) => {
            
            // Helper hook to persist state keyed by scenario ID
            const usePersistState = (key, defaultValue) => {
                const [state, setState] = useState(() => {
                    const scenarios = getScenarios();
                    if (scenarios[activeScenarioId]?.data?.[key] !== undefined) {
                        return scenarios[activeScenarioId].data[key];
                    }
                    return defaultValue;
                });

                useEffect(() => {
                    const scenarios = getScenarios();
                    if (!scenarios[activeScenarioId]) scenarios[activeScenarioId] = { name: 'Recovered', data: {} };
                    scenarios[activeScenarioId].data[key] = state;
                    localStorage.setItem(STORAGE_PREFIX + 'scenarios', JSON.stringify(scenarios));
                }, [key, state, activeScenarioId]);
                
                return [state, setState];
            };

            const [activeTab, setActiveTab] = useState('capital-gains');

            // --- States ---
            const [buyPrice, setBuyPrice] = usePersistState('buyPrice', 1000);
            const [sellPrice, setSellPrice] = usePersistState('sellPrice', 1500);
            const [buyDate, setBuyDate] = usePersistState('buyDate', '2021-01-01');
            const [sellDate, setSellDate] = usePersistState('sellDate', '2025-06-01');
            const [renovationCost, setRenovationCost] = usePersistState('renovationCost', 0);
            const [agentFee, setAgentFee] = usePersistState('agentFee', 0);
            const [otherCosts, setOtherCosts] = usePersistState('otherCosts', 0);
            const [landIncrementTax, setLandIncrementTax] = usePersistState('landIncrementTax', 0);
            const [isSelfUse, setIsSelfUse] = usePersistState('isSelfUse', false);

            const [oldMethod, setOldMethod] = usePersistState('oldMethod', 'standard');
            const [oldBuyPrice, setOldBuyPrice] = usePersistState('oldBuyPrice', 500);
            const [oldSellPrice, setOldSellPrice] = usePersistState('oldSellPrice', 1000);
            const [oldCosts, setOldCosts] = usePersistState('oldCosts', 50);
            const [houseRatio, setHouseRatio] = usePersistState('houseRatio', 30);
            const [houseAssessedValue, setHouseAssessedValue] = usePersistState('houseAssessedValue', 30);
            const [areaRatio, setAreaRatio] = usePersistState('areaRatio', 45);
            const [incomeTaxRate, setIncomeTaxRate] = usePersistState('incomeTaxRate', 20);

            const [estateForm, setEstateForm] = usePersistState('estateForm', { landValue: 0, houseValue: 0, deposits: 0, securities: 0, otherAssets: 0, hasSpouse: true, childrenCount: 2, parentCount: 0, siblingCount: 0, disabledCount: 0, funeralCostChecked: true, spouseClaim: 0, publicLandValue: 0, debts: 0 });
            const [giftForm, setGiftForm] = usePersistState('giftForm', { cashAmount: 500, propertyAssessed: 0, propertyMarket: 0 });
            const [insuranceForm, setInsuranceForm] = usePersistState('insuranceForm', { type: 'savings', premium: 100, years: 6, duration: 10, rate: 2.25, age: 40, taxBracket: 10 });

            const handleEstateChange = (name, value) => setEstateForm(prev => ({ ...prev, [name]: value }));
            const handleGiftChange = (name, value) => setGiftForm(prev => ({ ...prev, [name]: value }));
            const handleInsuranceChange = (name, value) => setInsuranceForm(prev => ({ ...prev, [name]: value }));

            // --- Calculations ---
            const newTaxResult = useMemo(() => {
                const start = new Date(buyPrice ? buyDate : new Date());
                const end = new Date(sellPrice ? sellDate : new Date());
                const diffTime = Math.abs(end - start);
                const yearsHeld = diffTime / (1000 * 60 * 60 * 24 * 365.25);
                const totalInputCosts = renovationCost + agentFee + otherCosts;
                const grossProfit = sellPrice - buyPrice - totalInputCosts - landIncrementTax;
                let taxRate = 0.45; let rateText = "45% (2å¹´å…§)";
                if (yearsHeld <= 2) { taxRate = 0.45; rateText = "45% (2å¹´å…§)"; } else if (yearsHeld <= 5) { taxRate = 0.35; rateText = "35% (2-5å¹´)"; } else if (yearsHeld <= 10) { taxRate = 0.20; rateText = "20% (5-10å¹´)"; } else { taxRate = 0.15; rateText = "15% (10å¹´ä»¥ä¸Š)"; }
                let finalTax = 0;
                if (isSelfUse) {
                    if (yearsHeld >= 6) { const taxable = Math.max(0, grossProfit - 400); finalTax = taxable * 0.10; rateText = "10% (è‡ªç”¨å„ªæƒ )"; } else { rateText += " (æœªæ»¿6å¹´)"; finalTax = Math.max(0, grossProfit * taxRate); }
                } else { finalTax = Math.max(0, grossProfit * taxRate); }
                return { yearsHeld: yearsHeld.toFixed(1), rateText, grossProfit: grossProfit.toFixed(1), finalTax: finalTax.toFixed(1), netProfit: (grossProfit - finalTax).toFixed(1) };
            }, [buyPrice, sellPrice, buyDate, sellDate, renovationCost, agentFee, otherCosts, landIncrementTax, isSelfUse]);

            const oldTaxResult = useMemo(() => {
                let taxableIncome = 0;
                if (oldMethod === 'actual') { const profit = Math.max(0, oldSellPrice - oldBuyPrice - oldCosts); taxableIncome = profit * (houseRatio / 100); } else { taxableIncome = houseAssessedValue * (areaRatio / 100); }
                const estimatedTax = taxableIncome * (incomeTaxRate / 100);
                return { taxableIncome: taxableIncome.toFixed(1), estimatedTax: estimatedTax.toFixed(1) };
            }, [oldMethod, oldSellPrice, oldBuyPrice, oldCosts, houseRatio, houseAssessedValue, areaRatio, incomeTaxRate]);

            const estateResult = useMemo(() => {
                const { landValue, houseValue, deposits, securities, otherAssets, hasSpouse, childrenCount, parentCount, siblingCount, disabledCount, funeralCostChecked, spouseClaim, publicLandValue, debts } = estateForm;
                const totalAssets = (landValue + houseValue + deposits + securities + otherAssets);
                let calculatedDeductions = 0;
                if (hasSpouse) calculatedDeductions += ESTATE_TAX_RULES_2025.deductions.spouse;
                calculatedDeductions += childrenCount * ESTATE_TAX_RULES_2025.deductions.child;
                calculatedDeductions += parentCount * ESTATE_TAX_RULES_2025.deductions.parent;
                calculatedDeductions += siblingCount * ESTATE_TAX_RULES_2025.deductions.sibling;
                calculatedDeductions += disabledCount * ESTATE_TAX_RULES_2025.deductions.disabled;
                if (funeralCostChecked) calculatedDeductions += ESTATE_TAX_RULES_2025.deductions.funeral;
                const totalSpecialDeductions = spouseClaim + debts + publicLandValue;
                const totalDeductionsFinal = calculatedDeductions + totalSpecialDeductions;
                const netTaxableEstate = Math.max(0, totalAssets - ESTATE_TAX_RULES_2025.exemption - totalDeductionsFinal);
                let finalTaxAmount = 0; let currentBracket = ESTATE_TAX_RULES_2025.brackets[0];
                for (const bracket of ESTATE_TAX_RULES_2025.brackets) { if (netTaxableEstate <= bracket.limit) { finalTaxAmount = (netTaxableEstate * bracket.rate) - bracket.progressiveDeduction; currentBracket = bracket; break; } }
                return { totalAssets, totalDeductionsFinal, netTaxableEstate, finalTaxAmount: Math.max(0, finalTaxAmount), taxRate: currentBracket.rate };
            }, [estateForm]);

            const giftResult = useMemo(() => {
                const { cashAmount, propertyAssessed, propertyMarket } = giftForm;
                const totalGiftValue = (cashAmount * 10000) + (propertyAssessed * 10000);
                const netTaxableGift = Math.max(0, totalGiftValue - GIFT_TAX_RULES_2025.exemption);
                let finalTaxAmount = 0; let currentBracket = GIFT_TAX_RULES_2025.brackets[0];
                for (const bracket of GIFT_TAX_RULES_2025.brackets) { if (netTaxableGift <= bracket.limit) { finalTaxAmount = (netTaxableGift * bracket.rate) - bracket.deduction; currentBracket = bracket; break; } }
                let taxIfCashGift = 0;
                if (propertyMarket > 0) {
                    const hypotheticalTotal = (cashAmount * 10000) + (propertyMarket * 10000);
                    const hypotheticalNet = Math.max(0, hypotheticalTotal - GIFT_TAX_RULES_2025.exemption);
                    for (const bracket of GIFT_TAX_RULES_2025.brackets) { if (hypotheticalNet <= bracket.limit) { taxIfCashGift = (hypotheticalNet * bracket.rate) - bracket.deduction; break; } }
                }
                const taxSavings = Math.max(0, taxIfCashGift - finalTaxAmount);
                return { totalGiftValue, netTaxableGift, finalTaxAmount: Math.max(0, finalTaxAmount), taxRate: currentBracket.rate, taxSavings, hasProperty: propertyAssessed > 0, taxIfCashGift };
            }, [giftForm]);

            const insuranceResult = useMemo(() => {
                const { type, premium, years, duration, rate, taxBracket } = insuranceForm;
                const safeDuration = Math.max(1, duration || 1);
                let chartData = []; let cumulativePremium = 0; let accumulatedValue = 0; const savingsSurrenderRatio = [0.6, 0.75, 0.85, 0.90, 0.95, 1.0]; 
                for (let t = 1; t <= safeDuration; t++) {
                    if (t <= years) { cumulativePremium += premium; accumulatedValue = (accumulatedValue + premium) * (1 + rate / 100); } else { accumulatedValue = accumulatedValue * (1 + rate / 100); }
                    let finalDisplayValue = accumulatedValue;
                    if (type === 'savings' && t <= 6) { const ratio = savingsSurrenderRatio[t-1] || 1.0; finalDisplayValue = accumulatedValue * ratio; }
                    chartData.push({ year: t, paid: Math.round(cumulativePremium), value: Math.round(finalDisplayValue) });
                }
                const lastPoint = chartData.length > 0 ? chartData[chartData.length - 1] : { value: 0, paid: 0 };
                const futureValue = lastPoint.value; const profit = futureValue - lastPoint.paid; const roi = lastPoint.paid > 0 ? (profit / lastPoint.paid) * 100 : 0;
                let potentialTaxSaving = 0;
                if (futureValue * 10000 <= INSURANCE_AMT_EXEMPTION) { potentialTaxSaving = futureValue * (taxBracket / 100); }
                return { totalCost: lastPoint.paid.toFixed(0), futureValue: futureValue.toFixed(0), profit: profit.toFixed(0), roi: roi.toFixed(1), chartData, potentialTaxSaving: potentialTaxSaving.toFixed(1), breakEvenYear: chartData.findIndex(d => d.value >= d.paid) + 1 };
            }, [insuranceForm]);

            const aiContext = useMemo(() => {
                let data = {}; let tabName = "";
                if (activeTab === 'capital-gains') { tabName = "æˆ¿åœ°åˆä¸€ç¨… (2.0)"; data = { buyPrice, sellPrice, buyDate, sellDate, costs: { renovationCost, agentFee, otherCosts, landIncrementTax }, isSelfUse, result: newTaxResult }; } 
                else if (activeTab === 'old-system') { tabName = "èˆŠåˆ¶è²¡ç”¢äº¤æ˜“æ‰€å¾—"; data = { method: oldMethod, input: oldMethod === 'standard' ? { houseAssessedValue, areaRatio } : { oldBuyPrice, oldSellPrice, oldCosts, houseRatio }, incomeTaxRate, result: oldTaxResult }; } 
                else if (activeTab === 'gift') { tabName = "è´ˆèˆ‡ç¨… (2025)"; data = { form: giftForm, result: giftResult }; } 
                else if (activeTab === 'estate') { tabName = "éºç”¢ç¨… (2025)"; data = { form: estateForm, result: estateResult }; } 
                else if (activeTab === 'insurance') { tabName = "ä¿éšªè³‡ç”¢è¦åŠƒ"; data = { form: insuranceForm, result: insuranceResult }; }
                return { data, tabName };
            }, [activeTab, buyPrice, sellPrice, buyDate, sellDate, renovationCost, agentFee, otherCosts, landIncrementTax, isSelfUse, newTaxResult, oldMethod, oldBuyPrice, oldSellPrice, oldCosts, houseRatio, houseAssessedValue, areaRatio, incomeTaxRate, oldTaxResult, giftForm, giftResult, estateForm, estateResult, insuranceForm, insuranceResult]);

            const aiSuggestions = useMemo(() => {
                const suggestions = [];
                if (activeTab === 'capital-gains') {
                    const held = parseFloat(newTaxResult.yearsHeld);
                    if (held < 2) suggestions.push({ type: 'warning', icon: <AlertCircle className="text-red-500" />, title: 'é«˜ç¨…ç‡è­¦ç¤º (45%)', content: 'æŒæœ‰æœªæ»¿ 2 å¹´ï¼Œç¨…ç‡ 45%ã€‚' });
                    else if (held > 1.8 && held < 2) suggestions.push({ type: 'tip', icon: <TrendingUp className="text-blue-500" />, title: 'å³å°‡é™ç¨…', content: 'å†æŒæœ‰å°‘è¨±æ™‚é–“å³æ»¿ 2 å¹´ï¼Œç¨…ç‡é™è‡³ 35%ã€‚' });
                    if (isSelfUse && held < 6) suggestions.push({ type: 'warning', icon: <Info className="text-amber-500" />, title: 'è‡ªç”¨å„ªæƒ æœªæ»¿æœŸ', content: 'éœ€æŒæœ‰æ»¿ 6 å¹´æ‰äº« 400 è¬å…ç¨…é¡ã€‚' });
                    if (renovationCost === 0 && agentFee === 0) suggestions.push({ type: 'tip', icon: <PiggyBank className="text-blue-500" />, title: 'æˆæœ¬æŠµæ‰£æé†’', content: 'è‹¥ç„¡æ³•æä¾›è²»ç”¨è­‰æ˜ï¼Œåœ‹ç¨…å±€åƒ…å…è¨±ä»¥æˆäº¤åƒ¹ 3% (ä¸Šé™ 30 è¬) è¨ˆç®—è²»ç”¨ã€‚' });
                }
                if (activeTab === 'old-system') {
                    if (oldMethod === 'standard') suggestions.push({ type: 'tip', icon: <Info className="text-blue-500" />, title: 'æ ¸å¯¦èªå®šæ¯”è¼ƒ', content: 'è‹¥ç•¶å¹´è²·åƒ¹è¼ƒé«˜ï¼Œç²åˆ©ä½æ–¼éƒ¨é ’æ¨™æº–ï¼Œæ¡ã€Œæ ¸å¯¦èªå®šã€å¯èƒ½æ›´åˆ’ç®—ã€‚' });
                    if (incomeTaxRate >= 30) suggestions.push({ type: 'warning', icon: <TrendingUp className="text-red-500" />, title: 'ç´¯é€²ç¨…ç‡å½±éŸ¿', content: 'èˆŠåˆ¶æ‰€å¾—ä½µå…¥ç¶œæ‰€ç¨…ï¼Œæ‚¨ç¨…ç‡è¼ƒé«˜ï¼Œå‡ºå”®å¯èƒ½é¡¯è‘—å¢åŠ ç¨…è² ã€‚' });
                }
                if (activeTab === 'gift') {
                    if (giftResult.taxSavings > 0) suggestions.push({ type: 'success', icon: <Home className="text-green-500" />, title: 'æˆ¿åœ°ç”¢ç¯€ç¨…æ•ˆç›Š', content: `åˆ©ç”¨å…¬å‘Šç¾å€¼è´ˆèˆ‡ï¼Œç›¸è¼ƒç¾é‡‘é ä¼°çœä¸‹ ${formatCurrency(giftResult.taxSavings)} ç¨…é‡‘ã€‚` });
                    if (giftForm.cashAmount > 244 && !giftResult.hasProperty) suggestions.push({ type: 'strategy', icon: <Users className="text-blue-500" />, title: 'çˆ¶æ¯åˆè´ˆç­–ç•¥', content: 'è‹¥è³‡é‡‘ä¾†è‡ªçˆ¶æ¯é›™æ–¹ï¼Œåˆè¨ˆæ¯å¹´å¯è´ˆèˆ‡å­å¥³ 488 è¬å…ƒå…ç¨…ã€‚' });
                }
                if (activeTab === 'estate') {
                    if (estateResult.netTaxableEstate > 56210000) suggestions.push({ type: 'strategy', icon: <Sparkles className="text-purple-500" />, title: 'å»ºè­°åˆ†å¹´è´ˆèˆ‡', content: `éºç”¢æ·¨é¡å·²é” ${estateResult.taxRate * 100}% ç¨…ç‡ã€‚` });
                    if (estateForm.hasSpouse && estateForm.spouseClaim === 0 && estateResult.totalAssets > 20000000) suggestions.push({ type: 'warning', icon: <AlertCircle className="text-amber-500" />, title: 'é…å¶å‰©é¤˜è²¡ç”¢å·®é¡', content: 'è³‡ç”¢è¼ƒé«˜ä¸”æœ‰é…å¶ï¼Œå–„ç”¨æ­¤è«‹æ±‚æ¬Šå¯å¤§å¹…é™ä½éºç”¢æ·¨é¡ã€‚' });
                }
                if (activeTab === 'insurance') {
                    if (insuranceForm.type === 'savings' && insuranceResult.breakEvenYear > 0) suggestions.push({ type: 'tip', icon: <Info className="text-blue-500" />, title: 'ä¿æœ¬é»æç¤º', content: `ç´„ç¬¬ ${insuranceResult.breakEvenYear} å¹´ä¿å–®åƒ¹å€¼è¶…éç´¯ç©ä¿è²»ã€‚` });
                    if (insuranceForm.age >= 70 || insuranceForm.type === 'savings') suggestions.push({ type: 'tip', icon: <Shield className="text-blue-500" />, title: 'å¯¦è³ªèª²ç¨…åŸå‰‡æé†’', content: 'é«˜é½¡æˆ–é‡ç—…æŠ•ä¿éœ€ç•™æ„åœ‹ç¨…å±€æŸ¥æ ¸é¢¨éšªã€‚' });
                }
                return suggestions;
            }, [activeTab, newTaxResult, isSelfUse, renovationCost, agentFee, oldMethod, incomeTaxRate, estateForm, estateResult, giftResult, giftForm, insuranceResult, insuranceForm]);

            // Pass summary text back to parent via ref or effect (simplified: just expose function)
            useEffect(() => {
                if (getSummaryTextRef) {
                    getSummaryTextRef.current = () => {
                         if (activeTab === 'capital-gains') return `ã€æˆ¿åœ°åˆä¸€ç¨…è©¦ç®—ã€‘\nğŸ”¹æŒæœ‰æœŸé–“ï¼š${newTaxResult.yearsHeld} å¹´\nğŸ”¹ç¨…å‰ç²åˆ©ï¼š${newTaxResult.grossProfit} è¬\nğŸ”¹é ä¼°ç¨…é¡ï¼š${newTaxResult.finalTax} è¬\nğŸ”¹ç¨…å¾Œæ·¨åˆ©ï¼š${newTaxResult.netProfit} è¬`;
                         if (activeTab === 'gift') return `ã€è´ˆèˆ‡ç¨…è©¦ç®— (2025)ã€‘\nğŸ”¹è´ˆèˆ‡ç¸½é¡ï¼š${formatCurrency(giftResult.totalGiftValue)}\nğŸ”¹é ä¼°ç¨…é¡ï¼š${formatCurrency(giftResult.finalTaxAmount)}\n${giftResult.taxSavings > 0 ? `âœ¨ ä½¿ç”¨æˆ¿ç”¢è¦åŠƒé ä¼°ç¯€ç¨…ï¼š${formatCurrency(giftResult.taxSavings)}` : ''}`;
                         if (activeTab === 'estate') return `ã€éºç”¢ç¨…è©¦ç®— (2025)ã€‘\nğŸ”¹éºç”¢ç¸½é¡ï¼š${formatCurrency(estateResult.totalAssets)}\nğŸ”¹é ä¼°ç¨…é¡ï¼š${formatCurrency(estateResult.finalTaxAmount)}\nğŸ”¹é©ç”¨ç¨…ç‡ï¼š${estateResult.taxRate * 100}%`;
                         if (activeTab === 'insurance') return `ã€ä¿éšªè³‡ç”¢è¦åŠƒã€‘\nğŸ”¹é¡å‹ï¼š${insuranceForm.type === 'savings' ? 'å„²è“„éšª' : 'æŠ•è³‡å‹'}\nğŸ”¹å¹´ç¹³ä¿è²»ï¼š${insuranceForm.premium} è¬ (å…± ${insuranceForm.years} å¹´)\nğŸ”¹${insuranceForm.duration} å¹´å¾Œåƒ¹å€¼ï¼š${insuranceResult.futureValue} è¬\nğŸ”¹é ä¼°ç²åˆ©ï¼š${insuranceResult.profit} è¬ (å ±é…¬ç‡ ${insuranceResult.roi}%)`;
                         return '';
                    }
                }
            }, [activeTab, newTaxResult, giftResult, estateResult, insuranceResult, insuranceForm]);

            return (
                <div className="animate-fade-in">
                {/* --- Tab Navigation --- */}
                <div className={`max-w-6xl mx-auto mt-6 px-4 print:hidden mb-6`}>
                    <div className={`flex space-x-2 p-1 overflow-x-auto ${theme.id==='zen' ? '' : ''}`}>
                    {[
                        { id: 'capital-gains', label: 'æˆ¿åœ°åˆä¸€ (æ–°åˆ¶)', icon: <TrendingUp size={16}/> },
                        { id: 'old-system', label: 'èˆŠåˆ¶äº¤æ˜“æ‰€å¾—', icon: <Archive size={16}/> },
                        { id: 'gift', label: '2025 è´ˆèˆ‡ç¨…', icon: <Gift size={16}/> },
                        { id: 'estate', label: '2025 éºç”¢ç¨…', icon: <Users size={16}/> },
                        { id: 'insurance', label: 'ä¿éšªè³‡ç”¢è¦åŠƒ', icon: <Umbrella size={16}/> }
                    ].map((tab) => (
                        <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex-1 flex items-center justify-center gap-2 py-3 px-4 text-sm transition-all whitespace-nowrap ${activeTab === tab.id ? theme.tabActive : theme.tabInactive} ${theme.id === 'zen' ? 'rounded-none' : 'rounded-xl'}`}>
                        {tab.icon} {tab.label}
                        </button>
                    ))}
                    </div>
                </div>

                <main className="max-w-6xl mx-auto p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
                    {/* ... (All Tab Content Logic) ... */}
                    {activeTab === 'capital-gains' && (
                        <>
                        <div className="lg:col-span-7 space-y-6">
                            <section className={theme.card}>
                                <div className={`flex items-center gap-2 mb-6 pb-2 border-b ${theme.id==='dark'?'border-slate-700':(theme.id==='zen'?'border-[#e6dfcc]':'border-gray-100')}`}> <Calendar className={theme.accentColor} /> <h2 className="text-xl font-bold">äº¤æ˜“è³‡è¨Š</h2> </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <InputField label="è²·å…¥åƒ¹æ ¼ (è¬)" type="number" value={buyPrice} onChange={v => setBuyPrice(parseInput(v))} theme={theme} readOnly={isPresentationMode} />
                                    <InputField label="é è¨ˆè³£å‡º (è¬)" type="number" value={sellPrice} onChange={v => setSellPrice(parseInput(v))} theme={theme} highlight readOnly={isPresentationMode} />
                                    <InputField label="è²·å…¥æ—¥æœŸ" type="date" value={buyDate} onChange={setBuyDate} theme={theme} prefix={<Calendar size={16}/>} readOnly={isPresentationMode} />
                                    <InputField label="è³£å‡ºæ—¥æœŸ" type="date" value={sellDate} onChange={setSellDate} theme={theme} prefix={<Calendar size={16}/>} readOnly={isPresentationMode} />
                                </div>
                            </section>
                            <section className={theme.card}>
                                <div className={`flex items-center gap-2 mb-6 pb-2 border-b ${theme.id==='dark'?'border-slate-700':(theme.id==='zen'?'border-[#e6dfcc]':'border-gray-100')}`}> <DollarSign className={theme.accentColor} /> <h2 className="text-xl font-bold">æˆæœ¬èˆ‡è‡ªç”¨</h2> </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <InputField label="ä»²ä»‹è²» (è¬)" type="number" value={agentFee} onChange={v => setAgentFee(parseInput(v))} theme={theme} readOnly={isPresentationMode} />
                                    <InputField label="è£ä¿®è²» (è¬)" type="number" value={renovationCost} onChange={v => setRenovationCost(parseInput(v))} theme={theme} readOnly={isPresentationMode} />
                                    <InputField label="ä»£æ›¸/é›œæ”¯ (è¬)" type="number" value={otherCosts} onChange={v => setOtherCosts(parseInput(v))} theme={theme} readOnly={isPresentationMode} />
                                    <InputField label="åœŸåœ°æ¼²åƒ¹ç¸½æ•¸é¡ (è¬)" type="number" value={landIncrementTax} onChange={v => setLandIncrementTax(parseInput(v))} theme={theme} readOnly={isPresentationMode} warning="* æ³¨æ„ï¼šè«‹å¡«ç¨…å–®ä¸Šçš„ã€ŒåœŸåœ°æ¼²åƒ¹ç¸½æ•¸é¡ã€ï¼Œéç¹³ç´çš„ç¨…é‡‘é‡‘é¡ã€‚" />
                                </div>
                                <div className="mt-6 pt-4 border-t border-gray-100/10">
                                    <label className="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-black/5 transition-colors">
                                    <input type="checkbox" checked={isSelfUse} onChange={(e) => setIsSelfUse(e.target.checked)} className="w-5 h-5 rounded text-blue-600" disabled={isPresentationMode} />
                                    <span className={`font-medium ${theme.id === 'dark' ? 'text-slate-300' : 'text-slate-700'}`}>ç¬¦åˆè‡ªç”¨ä½å®…å„ªæƒ  (æ»¿6å¹´ 400è¬å…ç¨…)</span>
                                    </label>
                                </div>
                            </section>
                        </div>
                        <div className="lg:col-span-5 relative">
                            <div className="lg:sticky lg:top-24 space-y-6">
                                <section className={theme.card}>
                                    <h2 className={`text-center text-xl font-bold mb-6 opacity-80 ${theme.id === 'zen' ? 'tracking-widest' : ''}`}>æˆ¿åœ°åˆä¸€ç¨…è©¦ç®—</h2>
                                    <div className="space-y-2 mb-6">
                                        <ResultRow label="æŒæœ‰æœŸé–“" value={`${newTaxResult.yearsHeld} å¹´`} theme={theme} />
                                        <ResultRow label="ç¨…å‰ç²åˆ©" value={`${newTaxResult.grossProfit} è¬`} theme={theme} />
                                        <ResultRow label="é©ç”¨ç¨…ç‡" value={newTaxResult.rateText} theme={theme} highlightColor="text-red-500" />
                                    </div>
                                    <div className={`${theme.resultBox} p-6 text-center`}>
                                        <p className="text-sm mb-2 opacity-80 font-bold">é ä¼°æ‡‰ç´ç¨…é¡</p>
                                        <p className="text-3xl font-black tracking-tight">{newTaxResult.finalTax} è¬</p>
                                        <div className="mt-4 pt-4 border-t border-white/20"> <p className="text-sm opacity-80">ç¨…å¾Œæ·¨åˆ©</p> <p className="text-xl font-bold text-emerald-400">{newTaxResult.netProfit} è¬</p> </div>
                                    </div>
                                </section>
                                <AIAdvisor suggestions={aiSuggestions} theme={theme} contextData={aiContext.data} tabName={aiContext.tabName} />
                            </div>
                        </div>
                        </>
                    )}

                    {activeTab === 'old-system' && (
                        <>
                        <div className="lg:col-span-7 space-y-6">
                        <section className={theme.card}>
                            <div className="flex gap-2 mb-6 print:hidden">
                                <button onClick={() => setOldMethod('standard')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${oldMethod === 'standard' ? theme.primaryBtn : 'bg-gray-100 text-gray-500'}`} disabled={isPresentationMode}>éƒ¨é ’æ¨™æº– (ç„¡è­‰æ˜)</button>
                                <button onClick={() => setOldMethod('actual')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${oldMethod === 'actual' ? theme.primaryBtn : 'bg-gray-100 text-gray-500'}`} disabled={isPresentationMode}>æ ¸å¯¦èªå®š (æœ‰è­‰æ˜)</button>
                            </div>
                            {oldMethod === 'standard' ? (
                                <div className="space-y-4">
                                    <InputField label="æˆ¿å±‹è©•å®šç¾å€¼ (è¬)" type="number" value={houseAssessedValue} onChange={v => setHouseAssessedValue(parseInput(v))} theme={theme} readOnly={isPresentationMode} />
                                    <InputField label="ä¾éƒ¨é ’æ¨™æº–ç‡ (%)" type="number" value={areaRatio} onChange={v => setAreaRatio(parseInput(v))} theme={theme} placeholder="é«˜é›„ç´„ 30-45%" readOnly={isPresentationMode} />
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                    <InputField label="è²·å…¥ç¸½åƒ¹ (è¬)" type="number" value={oldBuyPrice} onChange={v => setOldBuyPrice(parseInput(v))} theme={theme} readOnly={isPresentationMode} />
                                    <InputField label="è³£å‡ºç¸½åƒ¹ (è¬)" type="number" value={oldSellPrice} onChange={v => setOldSellPrice(parseInput(v))} theme={theme} readOnly={isPresentationMode} />
                                    </div>
                                    <InputField label="å–å¾—æˆæœ¬èˆ‡è²»ç”¨ (è¬)" type="number" value={oldCosts} onChange={v => setOldCosts(parseInput(v))} theme={theme} readOnly={isPresentationMode} />
                                    <InputField label="æˆ¿åœ°æ¯” - æˆ¿å±‹å æ¯” (%)" type="number" value={houseRatio} onChange={v => setHouseRatio(parseInput(v))} theme={theme} readOnly={isPresentationMode} />
                                </div>
                            )}
                            <div className="mt-6">
                                <SelectField label="æ‚¨çš„å€‹äººç¶œæ‰€ç¨…ç´šè·" value={incomeTaxRate} onChange={v => setIncomeTaxRate(Number(v))} theme={theme} readOnly={isPresentationMode} options={[ {value: 5, label: '5% (æ·¨é¡ 0-59è¬)'}, {value: 12, label: '12% (æ·¨é¡ 59-133è¬)'}, {value: 20, label: '20% (æ·¨é¡ 133-266è¬)'}, {value: 30, label: '30% (æ·¨é¡ 266-498è¬)'}, {value: 40, label: '40% (æ·¨é¡ 498è¬ä»¥ä¸Š)'}, ]} />
                            </div>
                        </section>
                        </div>
                        <div className="lg:col-span-5 relative">
                        <div className="lg:sticky lg:top-24 space-y-6">
                            <section className={theme.card}>
                                <h2 className={`text-center text-xl font-bold mb-6 opacity-80 ${theme.id === 'zen' ? 'tracking-widest' : ''}`}>èˆŠåˆ¶ç¨…é¡è©¦ç®—</h2>
                                <div className="space-y-2 mb-6">
                                    <ResultRow label="ç”³å ±è²¡ç”¢äº¤æ˜“æ‰€å¾—" value={`${oldTaxResult.taxableIncome} è¬`} theme={theme} />
                                    <ResultRow label="é©ç”¨ç¶œæ‰€ç¨…ç‡" value={`${incomeTaxRate}%`} theme={theme} />
                                </div>
                                <div className={`${theme.resultBox} p-6 text-center`}>
                                    <p className="text-sm mb-2 opacity-80 font-bold">é ä¼°å¢åŠ ç¨…é‡‘</p>
                                    <p className="text-3xl font-black tracking-tight">{oldTaxResult.estimatedTax} è¬</p>
                                </div>
                            </section>
                            <AIAdvisor suggestions={aiSuggestions} theme={theme} contextData={aiContext.data} tabName={aiContext.tabName} />
                        </div>
                        </div>
                        </>
                    )}

                    {activeTab === 'gift' && (
                    <>
                        <div className="lg:col-span-7 space-y-6">
                        <section className={theme.card}>
                            <div className={`flex items-center gap-2 mb-6 pb-2 border-b ${theme.id==='dark'?'border-slate-700':(theme.id==='zen'?'border-[#e6dfcc]':'border-gray-100')}`}> <Gift className={theme.accentColor} /> <h2 className="text-xl font-bold">è´ˆèˆ‡è¨­å®š</h2> </div>
                            <div className="space-y-6">
                                <InputField label="é è¨ˆè´ˆèˆ‡ç¾é‡‘ (è¬)" type="number" value={giftForm.cashAmount} onChange={v => handleGiftChange('cashAmount', parseInput(v))} theme={theme} readOnly={isPresentationMode} />
                                <div className={`p-4 rounded-xl border ${theme.id === 'dark' ? 'bg-slate-800 border-slate-600' : 'bg-gray-50 border-gray-100'} print:bg-white`}>
                                    <h3 className={`text-sm font-bold mb-3 flex items-center gap-2 ${theme.id==='dark'?'text-slate-300':'text-gray-700'}`}><Home size={16}/> æˆ¿åœ°ç”¢åƒ¹å€¼è¨­å®š</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <InputField label="å…¬å‘ŠåœŸåœ°+æˆ¿å±‹ç¾å€¼ (è¬)" type="number" value={giftForm.propertyAssessed} onChange={v => handleGiftChange('propertyAssessed', parseInput(v))} theme={theme} placeholder="è¨ˆç®—ç¨…é¡ç”¨" highlight readOnly={isPresentationMode} />
                                    <InputField label="æˆ¿ç”¢ä¼°è¨ˆå¸‚åƒ¹ (è¬)" type="number" value={giftForm.propertyMarket} onChange={v => handleGiftChange('propertyMarket', parseInput(v))} theme={theme} placeholder="æ¯”è¼ƒæ•ˆç›Šç”¨" readOnly={isPresentationMode} />
                                    </div>
                                </div>
                            </div>
                        </section>
                        </div>
                        <div className="lg:col-span-5 relative">
                        <div className="lg:sticky lg:top-24 space-y-6">
                            <section className={theme.card}>
                                <h2 className={`text-center text-xl font-bold mb-6 opacity-80 ${theme.id === 'zen' ? 'tracking-widest' : ''}`}>è´ˆèˆ‡ç¨…è©¦ç®—</h2>
                                <div className="space-y-2 mb-6">
                                    <ResultRow label="è´ˆèˆ‡ç¸½é¡" value={giftResult.totalGiftValue} theme={theme} />
                                    <ResultRow label="å…ç¨…é¡" value={GIFT_TAX_RULES_2025.exemption} isDeduction theme={theme} />
                                    <ResultRow label="èª²ç¨…æ·¨é¡" value={giftResult.netTaxableGift} theme={theme} highlightColor="text-blue-500 font-bold" />
                                </div>
                                <div className={`${theme.resultBox} p-6 text-center`}>
                                    <p className="text-sm mb-2 opacity-80 font-bold">é ä¼°æ‡‰ç´è´ˆèˆ‡ç¨…</p>
                                    <p className="text-3xl font-black tracking-tight">{formatCurrency(giftResult.finalTaxAmount)}</p>
                                </div>
                                <TaxBracketProgress currentAmount={giftResult.netTaxableGift} brackets={GIFT_TAX_RULES_2025.brackets} theme={theme} />
                            </section>
                            {giftForm.propertyMarket > 0 && giftForm.propertyAssessed > 0 && (
                                <ComparisonBarChart cashTax={giftResult.taxIfCashGift} propertyTax={giftResult.finalTaxAmount} theme={theme} />
                            )}
                            <AIAdvisor suggestions={aiSuggestions} theme={theme} contextData={aiContext.data} tabName={aiContext.tabName} />
                        </div>
                        </div>
                    </>
                    )}

                    {activeTab === 'estate' && (
                    <>
                        <div className="lg:col-span-7 space-y-6">
                        <section className={theme.card}>
                            <div className={`flex items-center gap-2 mb-6 pb-2 border-b ${theme.id==='dark'?'border-slate-700':(theme.id==='zen'?'border-[#e6dfcc]':'border-gray-100')}`}> <DollarSign className={theme.accentColor} /> <h2 className="text-xl font-bold">è³‡ç”¢ç¸½é¡</h2> </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-5 mb-6">
                            <InputField label="åœŸåœ°å…¬å‘Šç¾å€¼åˆè¨ˆ" type="number" value={estateForm.landValue} onChange={v => handleEstateChange('landValue', parseInput(v))} theme={theme} readOnly={isPresentationMode} />
                            <InputField label="æˆ¿å±‹è©•å®šç¾å€¼åˆè¨ˆ" type="number" value={estateForm.houseValue} onChange={v => handleEstateChange('houseValue', parseInput(v))} theme={theme} readOnly={isPresentationMode} />
                            <InputField label="å­˜æ¬¾ / ç¾é‡‘" type="number" value={estateForm.deposits} onChange={v => handleEstateChange('deposits', parseInput(v))} theme={theme} readOnly={isPresentationMode} />
                            <InputField label="è‚¡ç¥¨ / åŸºé‡‘" type="number" value={estateForm.securities} onChange={v => handleEstateChange('securities', parseInput(v))} theme={theme} readOnly={isPresentationMode} />
                            <div className="md:col-span-2"> <InputField label="å…¶ä»–è³‡ç”¢" type="number" value={estateForm.otherAssets} onChange={v => handleEstateChange('otherAssets', parseInput(v))} theme={theme} readOnly={isPresentationMode} /> </div>
                            </div>
                            <div className={`p-4 rounded-xl border ${theme.id === 'dark' ? 'bg-slate-800 border-slate-600' : 'bg-gray-50 border-gray-100'} print:bg-white`}> <h3 className={`text-sm font-bold mb-4 flex items-center gap-2 ${theme.id==='dark'?'text-slate-300':'text-gray-700'}`}><PieChartIcon size={16}/> è³‡ç”¢åˆ†ä½ˆæ¦‚æ³</h3> <div className="flex justify-center"><SimplePieChart data={estateResult.chartData} theme={theme} /></div> </div>
                        </section>
                        <section className={theme.card}>
                            <div className={`flex items-center gap-2 mb-6 pb-2 border-b ${theme.id==='dark'?'border-slate-700':(theme.id==='zen'?'border-[#e6dfcc]':'border-gray-100')}`}> <Users className={theme.accentColor} /> <h2 className="text-xl font-bold">å®¶åº­èˆ‡æ‰£é™¤é¡</h2> </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label className={theme.inputLabel}>æ˜¯å¦æœ‰é…å¶ (æ‰£é™¤ 553 è¬)</label>
                                <div className="flex gap-2">
                                    <button className={`flex-1 py-2 rounded-lg transition-all text-sm font-bold ${!estateForm.hasSpouse ? theme.primaryBtn : 'bg-gray-100 text-gray-500'}`} onClick={() => handleEstateChange('hasSpouse', false)} disabled={isPresentationMode}>ç„¡</button>
                                    <button className={`flex-1 py-2 rounded-lg transition-all text-sm font-bold ${estateForm.hasSpouse ? theme.primaryBtn : 'bg-gray-100 text-gray-500'}`} onClick={() => handleEstateChange('hasSpouse', true)} disabled={isPresentationMode}>æœ‰</button>
                                </div>
                            </div>
                            <InputField label="ç›´ç³»å‘è¦ªå±¬ (56è¬/äºº)" type="number" value={estateForm.childrenCount} onChange={v => handleEstateChange('childrenCount', parseInput(v))} theme={theme} readOnly={isPresentationMode} />
                            <InputField label="çˆ¶æ¯ (138è¬/äºº)" type="number" value={estateForm.parentCount} onChange={v => handleEstateChange('parentCount', parseInput(v))} theme={theme} readOnly={isPresentationMode} />
                            <InputField label="å—æ‰¶é¤Šæ‰‹è¶³ (56è¬/äºº)" type="number" value={estateForm.siblingCount} onChange={v => handleEstateChange('siblingCount', parseInput(v))} theme={theme} readOnly={isPresentationMode} />
                            <div className="md:col-span-2"> <InputField label="é‡åº¦èº«å¿ƒéšœç¤™ (åŠ è¨ˆ693è¬/äºº)" type="number" value={estateForm.disabledCount} onChange={v => handleEstateChange('disabledCount', parseInput(v))} theme={theme} readOnly={isPresentationMode} /> </div>
                            <div className="md:col-span-2 pt-2"> <label className="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-black/5 transition-colors"> <input type="checkbox" checked={estateForm.funeralCostChecked} onChange={(e) => handleEstateChange('funeralCostChecked', e.target.checked)} className="w-5 h-5 rounded text-blue-600" disabled={isPresentationMode} /> <span className={`font-medium ${theme.id === 'dark' ? 'text-slate-300' : 'text-slate-700'}`}>ç”³å ±å–ªè‘¬è²» (å®šé¡æ‰£é™¤ 138 è¬)</span> </label> </div>
                            </div>
                        </section>
                        <section className={theme.card}>
                            <div className={`flex items-center gap-2 mb-6 pb-2 border-b ${theme.id==='dark'?'border-slate-700':(theme.id==='zen'?'border-[#e6dfcc]':'border-gray-100')}`}> <PiggyBank className={theme.accentColor} /> <h2 className="text-xl font-bold">ç‰¹æ®Šæ‰£é™¤é …ç›®</h2> </div>
                            <div className="space-y-4">
                            <InputField label="é…å¶å‰©é¤˜è²¡ç”¢å·®é¡åˆ†é…è«‹æ±‚æ¬Š" type="number" value={estateForm.spouseClaim} onChange={v => handleEstateChange('spouseClaim', parseInput(v))} theme={theme} readOnly={isPresentationMode} />
                            <InputField label="å…¬å…±è¨­æ–½ä¿ç•™åœ° / è¾²åœ°åƒ¹å€¼ (å…ç¨…)" type="number" value={estateForm.publicLandValue} onChange={v => handleEstateChange('publicLandValue', parseInput(v))} theme={theme} readOnly={isPresentationMode} />
                            <InputField label="è¢«ç¹¼æ‰¿äººç”Ÿå‰æœªå„Ÿå‚µå‹™" type="number" value={estateForm.debts} onChange={v => handleEstateChange('debts', parseInput(v))} theme={theme} readOnly={isPresentationMode} />
                            </div>
                        </section>
                        </div>
                        <div className="lg:col-span-5 relative">
                        <div className="lg:sticky lg:top-24 space-y-6">
                            <section className={theme.card}>
                                <h2 className={`text-center text-xl font-bold mb-6 opacity-80 ${theme.id === 'zen' ? 'tracking-widest' : ''}`}>éºç”¢ç¨…è©¦ç®—</h2>
                                <div className="space-y-2 mb-6">
                                    <ResultRow label="éºç”¢ç¸½é¡" value={estateResult.totalAssets} theme={theme} />
                                    <ResultRow label="å…ç¨…é¡" value={ESTATE_TAX_RULES_2025.exemption} isDeduction theme={theme} />
                                    <ResultRow label="æ‰£é™¤é¡ç¸½è¨ˆ" value={estateResult.totalDeductionsFinal} isDeduction theme={theme} />
                                    <div className={`my-4 border-b ${theme.id === 'zen' ? 'border-[#e6dfcc]' : 'border-gray-100/10'}`}></div>
                                    <div className="flex justify-between items-center font-bold text-lg mb-1"> <span className={theme.id==='dark'?'text-slate-400':'text-slate-700'}>èª²ç¨…éºç”¢æ·¨é¡</span> <span className={theme.id==='dark'?'text-slate-200':'text-slate-900'}>{formatCurrency(estateResult.netTaxableEstate)}</span> </div>
                                </div>
                                <div className={`${theme.resultBox} p-6 text-center relative overflow-hidden`}> <p className="text-sm mb-2 opacity-80 font-bold">é ä¼°æ‡‰ç´éºç”¢ç¨…é¡</p> <p className="text-3xl font-black tracking-tight">{formatCurrency(estateResult.finalTaxAmount)}</p> </div>
                                <TaxBracketProgress currentAmount={estateResult.netTaxableEstate} brackets={ESTATE_TAX_RULES_2025.brackets} theme={theme} />
                                <EstateStackChart totalAssets={estateResult.totalAssets} totalDeductions={estateResult.totalDeductionsFinal} theme={theme} />
                            </section>
                            <AIAdvisor suggestions={aiSuggestions} theme={theme} contextData={aiContext.data} tabName={aiContext.tabName} />
                        </div>
                        </div>
                    </>
                    )}

                    {activeTab === 'insurance' && (
                    <>
                        <div className="lg:col-span-7 space-y-6">
                            <section className={theme.card}>
                                <div className={`flex items-center gap-2 mb-6 pb-2 border-b ${theme.id==='dark'?'border-slate-700':(theme.id==='zen'?'border-[#e6dfcc]':'border-gray-100')}`}> <Umbrella className={theme.accentColor} /> <h2 className="text-xl font-bold">ä¿éšªå…§å®¹è¨­å®š</h2> </div>
                                <div className="space-y-4">
                                    <div className="flex gap-2 mb-4">
                                        <button onClick={() => { handleInsuranceChange('type', 'savings'); handleInsuranceChange('rate', 2.25); }} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${insuranceForm.type === 'savings' ? theme.primaryBtn : 'bg-gray-100 text-gray-500'}`} disabled={isPresentationMode}>å„²è“„éšª (å›ºå®šåˆ©ç‡)</button>
                                        <button onClick={() => { handleInsuranceChange('type', 'investment'); handleInsuranceChange('rate', 5.0); }} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${insuranceForm.type === 'investment' ? theme.primaryBtn : 'bg-gray-100 text-gray-500'}`} disabled={isPresentationMode}>æŠ•è³‡å‹ä¿å–® (è®Šå‹•åˆ©ç‡)</button>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                                        <InputField label="å¹´ç¹³ä¿è²» (è¬)" type="number" value={insuranceForm.premium} onChange={v => handleInsuranceChange('premium', parseInput(v))} theme={theme} readOnly={isPresentationMode} />
                                        <InputField label="ç¹³è²»å¹´æœŸ (å¹´)" type="number" value={insuranceForm.years} onChange={v => handleInsuranceChange('years', parseInput(v))} theme={theme} readOnly={isPresentationMode} />
                                        <InputField label="ç´¯ç©æœŸé–“ (å¹´)" type="number" value={insuranceForm.duration} onChange={v => handleInsuranceChange('duration', parseInput(v))} theme={theme} placeholder="é è¨ˆæŒæœ‰æ™‚é–“" readOnly={isPresentationMode} />
                                        <InputField label={insuranceForm.type === 'savings' ? 'é å®š/å®£å‘Šåˆ©ç‡ (%)' : 'é ä¼°å¹´åŒ–æ·¨å ±é…¬ç‡ (%)'} type="number" value={insuranceForm.rate} onChange={v => handleInsuranceChange('rate', parseInput(v))} theme={theme} step={0.1} readOnly={isPresentationMode} />
                                        <InputField label="æŠ•ä¿å¹´é½¡ (æ­²)" type="number" value={insuranceForm.age} onChange={v => handleInsuranceChange('age', parseInput(v))} theme={theme} placeholder="ç”¨æ–¼è©•ä¼°å¯¦è³ªèª²ç¨…é¢¨éšª" readOnly={isPresentationMode} />
                                        <SelectField label="é ä¼°æ‚¨çš„éºç”¢ç¨…ç‡ç´šè·" value={insuranceForm.taxBracket} onChange={v => handleInsuranceChange('taxBracket', Number(v))} theme={theme} readOnly={isPresentationMode} options={[ {value: 10, label: '10% (æ·¨é¡ 5000è¬ä»¥ä¸‹)'}, {value: 15, label: '15% (æ·¨é¡ 5000è¬-1å„„)'}, {value: 20, label: '20% (æ·¨é¡ 1å„„ä»¥ä¸Š)'} ]} />
                                    </div>
                                </div>
                            </section>
                            <section className={theme.card}>
                                <div className={`flex items-center gap-2 mb-4 pb-2 border-b ${theme.id==='dark'?'border-slate-700':(theme.id==='zen'?'border-[#e6dfcc]':'border-gray-100')}`}> <BarChart2 className={theme.accentColor} size={20} /> <h2 className="text-lg font-bold">ä¿å–®åƒ¹å€¼èµ°å‹¢åˆ†æ</h2> </div>
                                <LineChart data={insuranceResult.chartData} theme={theme} />
                                <div className="flex justify-center gap-4 mt-2"> <div className="flex items-center gap-1 text-xs text-slate-500"><div className="w-3 h-1 bg-slate-300"></div>è™›ç·šï¼šç´¯ç©å·²ç¹³ä¿è²»</div> <div className="flex items-center gap-1 text-xs text-slate-500"><div className={`w-3 h-1 ${theme.id==='nordic'?'bg-[#2f8565]':(theme.id==='dark'?'bg-[#22d3ee]':'bg-[#8f5e47]')}`}></div>å¯¦ç·šï¼šä¿å–®é ä¼°åƒ¹å€¼</div> </div>
                            </section>
                        </div>
                        <div className="lg:col-span-5 relative">
                            <div className="lg:sticky lg:top-24 space-y-6">
                                <section className={theme.card}>
                                    <h2 className={`text-center text-xl font-bold mb-6 opacity-80 ${theme.id === 'zen' ? 'tracking-widest' : ''}`}>ä¿å–®åƒ¹å€¼è©¦ç®—</h2>
                                    <div className="space-y-2 mb-6">
                                        <ResultRow label="ç´¯ç©ç¸½ç¹³ä¿è²»" value={`${insuranceResult.totalCost} è¬`} theme={theme} />
                                        <ResultRow label="é ä¼°æœŸæ»¿åƒ¹å€¼" value={`${insuranceResult.futureValue} è¬`} theme={theme} highlightColor="text-blue-500 font-bold" />
                                        <ResultRow label="é ä¼°ç¸½æç›Š" value={`${insuranceResult.profit} è¬`} theme={theme} highlightColor={parseFloat(insuranceResult.profit) >= 0 ? "text-green-500" : "text-red-500"} />
                                    </div>
                                    <div className={`${theme.resultBox} p-6 text-center`}> <p className="text-sm mb-2 opacity-80 font-bold">ç´¯ç©ç¸½å ±é…¬ç‡ (ROI)</p> <p className="text-3xl font-black tracking-tight">{insuranceResult.roi}%</p> </div>
                                    {parseFloat(insuranceResult.potentialTaxSaving) > 0 && (
                                        <div className={`mt-4 p-4 rounded-xl border ${theme.id==='dark'?'bg-emerald-900/30 border-emerald-800 text-emerald-300':'bg-emerald-50 border-emerald-100 text-emerald-800'}`}>
                                            <div className="flex items-center gap-2 font-bold mb-1"> <Shield size={16} /> æ½›åœ¨éºç”¢ç¨…ç¯€ç¨…æ•ˆç›Š </div>
                                            <p className="text-xs opacity-90 mb-2">è‹¥æ­¤ä¿å–®ç¬¦åˆå…ç¨…è¦å®šï¼Œç›¸è¼ƒæ–¼ç¾é‡‘éºç”¢ï¼Œé ä¼°å¯ç¯€çœï¼š</p>
                                            <p className="text-2xl font-black"> {insuranceResult.potentialTaxSaving} <span className="text-base font-normal">è¬</span> </p>
                                        </div>
                                    )}
                                </section>
                                <AIAdvisor suggestions={aiSuggestions} theme={theme} contextData={aiContext.data} tabName={aiContext.tabName} />
                            </div>
                        </div>
                    </>
                    )}
                </main>
                </div>
            );
        };
        
        // --- Main App Container (Manages Scenario & Theme) ---
        function App() {
            const [currentThemeId, setCurrentThemeId] = useState('nordic');
            const [activeScenarioId, setActiveScenarioId] = useState('default');
            const [isPresentationMode, setIsPresentationMode] = useState(false);
            const theme = THEMES[currentThemeId];
            
            const scenarios = useMemo(() => {
                try {
                    const saved = localStorage.getItem(STORAGE_PREFIX + 'scenarios');
                    return saved ? JSON.parse(saved) : { 'default': { name: 'é è¨­å®¢æˆ¶', data: {} } };
                } catch { return { 'default': { name: 'é è¨­å®¢æˆ¶', data: {} } }; }
            }, [activeScenarioId]); // Re-read when active changes to update list if needed

            const handleReset = () => {
                if(window.confirm('ç¢ºå®šè¦æ¸…é™¤ç•¶å‰å®¢æˆ¶è³‡æ–™ä¸¦é‡ç½®å—ï¼Ÿ')) {
                    const savedScenarios = getScenarios();
                    savedScenarios[activeScenarioId].data = {}; 
                    localStorage.setItem(STORAGE_PREFIX + 'scenarios', JSON.stringify(savedScenarios));
                    window.location.reload();
                }
            };
            
            const handleNewScenario = () => {
                const name = prompt("è«‹è¼¸å…¥æ–°å®¢æˆ¶åç¨±", `å®¢æˆ¶ ${new Date().toLocaleTimeString()}`);
                if(name) {
                    const id = Date.now().toString();
                    const savedScenarios = getScenarios();
                    savedScenarios[id] = { name, data: {} };
                    localStorage.setItem(STORAGE_PREFIX + 'scenarios', JSON.stringify(savedScenarios));
                    setActiveScenarioId(id);
                }
            }

            // New: Delete Scenario Function
            const handleDeleteScenario = () => {
                if (activeScenarioId === 'default') {
                    if(window.confirm('ã€Œé è¨­å®¢æˆ¶ã€ç„¡æ³•åˆªé™¤ï¼Œæ˜¯å¦è¦æ¸…é™¤æ‰€æœ‰è¼¸å…¥è³‡æ–™ï¼Ÿ')) {
                        handleReset();
                    }
                    return;
                }
                
                const scenarios = getScenarios();
                const name = scenarios[activeScenarioId]?.name || 'æ­¤å®¢æˆ¶';
                
                if(window.confirm(`ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ã€Œ${name}ã€çš„æ‰€æœ‰è³‡æ–™å—ï¼Ÿ\næ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`)) {
                    delete scenarios[activeScenarioId];
                    localStorage.setItem(STORAGE_PREFIX + 'scenarios', JSON.stringify(scenarios));
                    setActiveScenarioId('default');
                    window.location.reload();
                }
            };

            const getSummaryTextRef = useRef(null);
            const [copyFeedback, setCopyFeedback] = useState("");

            const handleCopy = () => {
                if (getSummaryTextRef.current) {
                    const text = getSummaryTextRef.current();
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.top = "0"; textArea.style.left = "0"; textArea.style.position = "fixed";
                    document.body.appendChild(textArea);
                    textArea.focus(); textArea.select();
                    try { document.execCommand('copy'); setCopyFeedback("å·²è¤‡è£½"); setTimeout(() => setCopyFeedback(""), 2000); } catch (err) { console.error('Copy failed', err); }
                    document.body.removeChild(textArea);
                }
            };

            return (
                <div className={`min-h-screen pb-24 lg:pb-0 ${theme.bgMain}`}>
                    {/* Header */}
                    <header className={`sticky top-0 z-30 px-4 py-4 ${theme.header}`}>
                        <div className="max-w-6xl mx-auto flex flex-col sm:flex-row items-center justify-between gap-4">
                        <div className="flex items-center gap-3">
                            <div className={`p-2 rounded-lg ${theme.id === 'dark' ? 'bg-cyan-900/50 text-cyan-400' : (theme.id === 'zen' ? 'bg-[#e6dfcc] text-[#595045]' : 'bg-[#c8e1d6] text-[#2c5f4c]')}`}> <Calculator size={24} /> </div>
                            <div> <h1 className="text-xl md:text-2xl font-bold tracking-tight">æˆ¿ç”¢èˆ‡è³‡ç”¢ç¨…å‹™å…¨èƒ½è¨ˆç®—æ©Ÿ</h1> <p className="text-xs opacity-60 flex items-center gap-2"> <span className="hidden md:inline">æ•´åˆ 2025 éºç”¢/è´ˆèˆ‡ç¨…ã€æˆ¿åœ°åˆä¸€ 2.0</span> <span className={`px-2 py-0.5 rounded-full text-[10px] font-bold ${theme.id==='dark'?'bg-slate-700':'bg-white/50'}`}>Sales Pro</span> </p> </div>
                        </div>
                        <div className="flex flex-wrap gap-2 justify-end items-center">
                            <div className="relative">
                                <select value={activeScenarioId} onChange={(e) => { if(e.target.value === 'new') handleNewScenario(); else setActiveScenarioId(e.target.value); }} className={`appearance-none pl-8 pr-8 py-1.5 rounded-lg text-sm font-bold cursor-pointer outline-none focus:ring-2 ${theme.id==='dark'?'bg-slate-800 text-white ring-cyan-500':'bg-white text-slate-700 ring-blue-200'}`}>
                                    {Object.entries(scenarios).map(([id, s]) => ( <option key={id} value={id}>{s.name}</option> ))}
                                    <option value="new">â• æ–°å¢å®¢æˆ¶...</option>
                                </select>
                                <Users size={14} className="absolute left-2.5 top-1/2 -translate-y-1/2 opacity-50 pointer-events-none" />
                            </div>

                            {/* Delete Button */}
                            <button 
                                onClick={handleDeleteScenario}
                                className={`p-2 rounded-md transition-all hover:bg-red-50 text-gray-400 hover:text-red-600 ${activeScenarioId === 'default' ? 'opacity-50' : ''}`}
                                title={activeScenarioId === 'default' ? "æ¸…é™¤é è¨­è³‡æ–™" : "åˆªé™¤æ­¤å®¢æˆ¶æª”æ¡ˆ"}
                            >
                                <Trash2 size={18} />
                            </button>

                            <button onClick={() => setIsPresentationMode(!isPresentationMode)} className={`p-2 rounded-md transition-all hover:opacity-80 flex items-center gap-1 text-sm font-bold ${isPresentationMode ? 'bg-indigo-100 text-indigo-600 ring-2 ring-indigo-500' : 'text-gray-500 hover:bg-gray-100'}`} title="åˆ‡æ›ç°¡å ±æ¨¡å¼ (å”¯è®€)"> {isPresentationMode ? <EyeOff size={18} /> : <Eye size={18} />} <span className="hidden md:inline">{isPresentationMode ? 'é€€å‡ºç°¡å ±' : 'ç°¡å ±æ¨¡å¼'}</span> </button>
                            
                            {/* Reset Button (now handled by delete mostly, but keep for field clear) */}
                            <button onClick={handleReset} className="p-2 rounded-md transition-all hover:bg-gray-100 text-gray-400 hover:text-gray-600" title="é‡ç½®æ¬„ä½"> <RotateCcw size={18} /> </button>
                            
                            <button onClick={handleCopy} className={`p-2 rounded-md transition-all hover:opacity-70 flex items-center gap-1 text-sm ${copyFeedback ? 'text-green-600 bg-green-50' : 'text-gray-600 hover:bg-gray-100'}`} title="è¤‡è£½å®¢æˆ¶å ±å‘Šæ‘˜è¦"> {copyFeedback ? <CheckCircle2 size={18} /> : <Copy size={18} />} <span className="hidden md:inline">{copyFeedback || 'æ‘˜è¦'}</span> </button>
                            <div className={`flex p-1 rounded-xl ${theme.id === 'dark' ? 'bg-slate-800 border border-slate-700' : (theme.id === 'zen' ? 'bg-[#f0ebe0]' : 'bg-[#e0e7e4]')}`}>
                                {Object.values(THEMES).map(t => ( <button key={t.id} onClick={() => setCurrentThemeId(t.id)} className={`flex items-center gap-2 px-2 py-1.5 rounded-lg text-xs font-bold transition-all ${ currentThemeId === t.id ? (t.id === 'dark' ? 'bg-cyan-900 text-cyan-400 shadow' : (t.id === 'zen' ? 'bg-[#fff] text-[#595045] shadow-sm' : 'bg-white text-[#2c5f4c] shadow-sm')) : 'opacity-40 hover:opacity-100' }`} title={t.name}> {t.icon} </button> ))}
                            </div>
                        </div>
                        </div>
                    </header>
                    
                    {/* Render Content with Key to force reset on scenario change */}
                    <TaxCalculatorContent 
                        key={activeScenarioId} 
                        activeScenarioId={activeScenarioId} 
                        theme={theme} 
                        isPresentationMode={isPresentationMode}
                        getSummaryTextRef={getSummaryTextRef}
                    />

                    <div className={`lg:hidden fixed bottom-0 left-0 right-0 z-40 p-4 shadow-lg ${theme.mobileFooter}`}>
                        <div className="max-w-6xl mx-auto flex items-center justify-between">
                        <div> <p className="text-xs opacity-70 font-bold">å°æç¤º</p> <p className={`text-sm font-black ${theme.accentColor}`}>å¯åˆ‡æ›ä¸åŒç¨…å‹™è©¦ç®—</p> </div>
                        <button onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })} className={`px-4 py-2 text-sm font-bold flex items-center gap-2 ${theme.primaryBtn}`}><ArrowRight size={16} /> å›åˆ°é ‚éƒ¨</button>
                        </div>
                    </div>
                    <DisclaimerFooter theme={theme} />
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
